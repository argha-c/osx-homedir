#!/usr/bin/env bash

set -e

main() {
  cd ~/

  softwareupdate_indicator=~/.softwareupdate_indicator
  if [ ! -f "${softwareupdate_indicator}" ]
  then
    echo Running system updates
    if (sudo softwareupdate -l | grep -q restart)
    then
      sudo softwareupdate -i -a && touch "${softwareupdate_indicator}"
      echo Reboot is needed
      exit 0
    else
      sudo softwareupdate -i -a && touch "${softwareupdate_indicator}"
    fi
  else
    last_run=$(echo $(($(date +%s) - $(stat -t %s -f %m -- "README.md"))))
    last_run_days=$(( $last_run / (24 * 60 * 60) ))
    echo Last software update was $last_run_days days ago
    if [ "${last_run_days}" -gt "7" ]
    then
      echo Going to run a softwareupdate since it has been a while
      echo Running system updates
      if (sudo softwareupdate -l | grep -q restart)
      then
        sudo softwareupdate -i -a && touch "${softwareupdate_indicator}"
        echo Reboot is needed
        exit 0
      else
        sudo softwareupdate -i -a && touch "${softwareupdate_indicator}"
      fi
    else
      echo Since softwareupdate ran recently, not going to do anything
      echo remove /tmp/ran_softwareupdate to force an update
    fi
  fi

  git submodule update --init --recursive

  if [ ! -d ~/workspace/sprout-wrap ]
  then
    git clone git@github.com:scottmuc/sprout-wrap ~/workspace/sprout-wrap
  fi

  ~/workspace/sprout-wrap/runsoloist

  if [ ! -x /usr/local/bin/brew ]
  then
    /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
  else
    brew update || true
  fi

  brew bundle
}

main
